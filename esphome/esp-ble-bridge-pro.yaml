substitutions:
  name: "esp-ble-bridge-pro"
  friendly_name: "BRMesh Pro Bridge"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  name_add_mac_suffix: true
  project:
    name: "brmesh.pro_bridge"
    version: "1.0.0"

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: arduino
  flash_size: 16MB
  
psram:
  mode: octal
  speed: 80MHz

# Enable logging
logger:
  level: DEBUG
  baud_rate: 115200

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "BRMesh-Pro-Fallback"
    password: "brmesh_recovery"

captive_portal:

# I2C for Touchscreen
i2c:
  sda: GPIO19
  scl: GPIO20
  scan: true
  id: bus_a

# Touchscreen Component
# touchscreen:
#   - platform: gt911
#     id: my_touch
#     i2c_id: bus_a
#     interrupt_pin: GPIO21 # Check if this pin is correct for your specific revision, sometimes it's different or unused
#     on_touch:
#       - lambda: |-
#           ESP_LOGI("touch", "Touch at (%d, %d)", touch.x, touch.y);

# Display Component (RGB Interface with ST7701)
# Note: ST7701 is not yet in stable ESPHome, using external component

# display:
#   - platform: st7701
#     id: my_display
    
#     # Pinout for Sunton ESP32-S3-8048S040
#     red:
#       - GPIO1
#       - GPIO2
#       - GPIO42
#       - GPIO41
#       - GPIO40
#     green:
#       - GPIO39
#       - GPIO38
#       - GPIO0
#       - GPIO45
#       - GPIO48
#       - GPIO47
#     blue:
#       - GPIO46
#       - GPIO3
#       - GPIO8
#       - GPIO18
#       - GPIO17
    
#     hsync_pin: GPIO4
#     vsync_pin: GPIO5
#     de_pin: GPIO6
#     pclk_pin: GPIO7
    
#     # 480x480 Resolution
#     width: 480
#     height: 480
    
#     # Timing parameters for ST7701 (Standard 480x480)
#     hsync_pulse_width: 10
#     hsync_back_porch: 50
#     hsync_front_porch: 10
#     vsync_pulse_width: 10
#     vsync_back_porch: 20
#     vsync_front_porch: 10
    
#     # Initialization sequence for ST7701
#     init_sequence:
#       # Software Reset
#       - 100ms
#       - [0x11, 0x00] 
#       - 500ms
      
#       # Command2BKx (Enable Command 2)
#       - [0xFF, 0x77, 0x01, 0x00, 0x00, 0x10]
      
#       # Standard ST7701 Init Sequence (Generic 480x480)
#       - [0xC0, 0x63, 0x00]
#       - [0xC1, 0x11, 0x02]
#       - [0xC2, 0x31, 0x02]
#       - [0xCC, 0x10]
#       - [0xB0, 0x00, 0x08, 0x10, 0x0E, 0x11, 0x07, 0x08, 0x09, 0x03, 0x22, 0x04, 0x10, 0x0E, 0x2C, 0x30, 0x1F]
#       - [0xB1, 0x00, 0x11, 0x19, 0x0C, 0x10, 0x06, 0x07, 0x0A, 0x05, 0x22, 0x06, 0x13, 0x10, 0x2F, 0x37, 0x1F]
      
#       # Enable Display
#       - [0x29, 0x00]
#       - 200ms

#     data_rate: 16MHz
    
#     # Basic UI for testing
#     lambda: |-
#       it.fill(Color::BLACK);
#       it.print(240, 200, id(roboto), Color::WHITE, TextAlign::CENTER, "BRMesh Pro");
#       it.print(240, 240, id(roboto), Color::GREEN, TextAlign::CENTER, "Touch to Scan");

# Fonts
font:
  - file: "gfonts://Roboto"
    id: roboto
    size: 30

# BRMesh Components
esp32_ble_tracker:
  scan_parameters:
    interval: 320ms
    window: 300ms
    active: true
    continuous: true

esp32_ble_server: {}

external_components:
  - source: github://tofuweasel/esphome-fastcon@optimized
    components: [fastcon]
  # - source: github://AlirezaT/esphome-st7701s-sleep
  #   components: [st7701]

fastcon:
  id: fastcon_controller
  mesh_key: !secret mesh_key

# Status LED (if available)
# status_led:
#   pin: GPIO38 # Often the backlight pin on these boards, check if it conflicts

# Backlight Control
output:
  - platform: ledc
    pin: GPIO38
    id: backlight_pwm
    frequency: 1000Hz

light:
  - platform: monochromatic
    output: backlight_pwm
    name: "Display Backlight"
    id: disp_backlight
    restore_mode: ALWAYS_ON
    default_transition_length: 0s

