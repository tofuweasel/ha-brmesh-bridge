# BRMesh Bridge - UDP Sound Sync MASTER
# ESP32 with microphone that broadcasts FFT data
# Other ESP32s can receive this data without needing their own mic

esphome:
  name: brmesh-music-master
  platform: ESP32
  board: esp32dev
  includes:
    - fft_analyzer_udp.h
  libraries:
    - "arduinoFFT"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

api:
  encryption:
    key: !secret api_key

logger:
  level: INFO

ota:
  password: !secret ota_password

# I2S Microphone (INMP441)
i2s_audio:
  i2s_lrclk_pin: GPIO25
  i2s_bclk_pin: GPIO26

microphone:
  - platform: i2s_audio
    id: mic
    adc_type: external
    i2s_din_pin: GPIO22
    bits_per_sample: 32bit

# BLE for BRMesh
esp32_ble_tracker:
  scan_parameters:
    interval: 1100ms
    window: 1100ms
    active: true

# UDP Sound Sync Configuration
globals:
  - id: udp_port
    type: int
    initial_value: '11988'  # WLED uses 11988
  - id: broadcast_enabled
    type: bool
    initial_value: 'true'

switch:
  - platform: template
    name: "Music Mode (Master)"
    id: music_mode
    icon: "mdi:music"
    optimistic: true
    turn_on_action:
      - lambda: |-
          id(music_effect)->start();
    turn_off_action:
      - lambda: |-
          id(music_effect)->stop();
  
  - platform: template
    name: "UDP Broadcast"
    id: udp_broadcast
    icon: "mdi:broadcast"
    optimistic: true
    initial_state: true
    turn_on_action:
      - lambda: |-
          id(music_effect)->enable_udp_broadcast(true);
    turn_off_action:
      - lambda: |-
          id(music_effect)->enable_udp_broadcast(false);

number:
  - platform: template
    name: "Music Sensitivity"
    id: music_sensitivity
    min_value: 0.1
    max_value: 5.0
    step: 0.1
    initial_value: 1.0
    mode: slider

custom_component:
  - lambda: |-
      auto music_reactive = new MusicReactiveEffectUDP(true);  // true = master mode
      App.register_component(music_reactive);
      return {music_reactive};
    components:
      - id: music_effect

text_sensor:
  - platform: template
    name: "UDP Broadcast Status"
    id: udp_status
    icon: "mdi:network"
    lambda: |-
      if (id(broadcast_enabled)) {
        return {"Broadcasting on port 11988"};
      } else {
        return {"Broadcast disabled"};
      }
    update_interval: 5s
