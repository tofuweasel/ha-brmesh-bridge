# BRMesh Bridge - UDP Sound Sync SLAVE
# ESP32 without microphone that receives FFT data from master
# Much cheaper - no microphone hardware needed!

esphome:
  name: brmesh-music-slave
  platform: ESP32
  board: esp32dev
  includes:
    - fft_analyzer_udp.h
  libraries:
    - "arduinoFFT"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

api:
  encryption:
    key: !secret api_key

logger:
  level: INFO

ota:
  password: !secret ota_password

# BLE for BRMesh (no microphone needed!)
esp32_ble_tracker:
  scan_parameters:
    interval: 1100ms
    window: 1100ms
    active: true

globals:
  - id: udp_port
    type: int
    initial_value: '11988'
  - id: master_ip
    type: std::string
    initial_value: '""'  # Auto-discover or set manually

switch:
  - platform: template
    name: "Music Mode (Slave)"
    id: music_mode
    icon: "mdi:music-note"
    optimistic: true
    turn_on_action:
      - lambda: |-
          id(music_effect)->start();
    turn_off_action:
      - lambda: |-
          id(music_effect)->stop();

text:
  - platform: template
    name: "Master IP Address"
    id: master_ip_input
    icon: "mdi:ip-network"
    mode: text
    optimistic: true
    initial_value: "auto"
    on_value:
      - lambda: |-
          if (x != "auto") {
            id(music_effect)->set_master_ip(x.c_str());
          }

number:
  - platform: template
    name: "Music Sensitivity"
    id: music_sensitivity
    min_value: 0.1
    max_value: 5.0
    step: 0.1
    initial_value: 1.0
    mode: slider

custom_component:
  - lambda: |-
      auto music_reactive = new MusicReactiveEffectUDP(false);  // false = slave mode
      App.register_component(music_reactive);
      return {music_reactive};
    components:
      - id: music_effect

text_sensor:
  - platform: template
    name: "UDP Receive Status"
    id: udp_status
    icon: "mdi:network"
    lambda: |-
      return id(music_effect)->get_status();
    update_interval: 2s

sensor:
  - platform: template
    name: "UDP Packets Received"
    id: packet_count
    icon: "mdi:counter"
    accuracy_decimals: 0
    lambda: |-
      return id(music_effect)->get_packet_count();
    update_interval: 1s
